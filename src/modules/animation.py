from DisplayUI import DisplayUI
from time import sleep_ms
import framebuf

def make_frame(logo, car, shift):
    img = bytearray(logo)
    for y in range(Hb):
        base_car = y * wb
        linea = 0
        for b in car[base_car:base_car+wb]:
            linea = (linea << 8) | b
        rot = ((linea >> shift) if shift >= 0 else (linea << -shift)) & mask_line

        base_logo = (y_offset + y) * wb
        logo_line = 0
        for b in logo[base_logo:base_logo+wb]:
            logo_line = (logo_line << 8) | b

        out_line = rot | logo_line
        for i in range(wb):
            shift_byte         = (wb - 1 - i) * 8
            img[base_logo + i] = (out_line >> shift_byte) & 0xFF

    return img


def overlay_rect(img, height):
    x0 = W - 2
    y0 = H - height
    for y in range(y0, H):
        for x in (x0, x0+1):
            idx = y * wb + (x >> 3)
            bit = 1 << (7 - (x & 7))
            img[idx] &= ~bit
    
    
def play_animation(oled, W, H, Hb, wb, mask_line, y_offset, car_width, rect_h):
    #scroll car
    for shift in range(-car_width, W + 1):
        img = make_frame(logo, car, shift)
        if rect_h > 0:
            overlay_rect(img, rect_h)
        oled.show_image(img)
        sleep_ms(10)

        #lift garage shutter
        if shift == 0 and rect_h == 0:
            sleep_ms(1500)
            for h in range(1, 15):
                rect_h = h
                frame = bytearray(img)
                overlay_rect(frame, rect_h)
                oled.show_image(frame)
                sleep_ms(200)
        
        #save frame when car disappear from screen
        if shift == W-99:
            overlay_rect(img, rect_h)
            break

    #scroll text
    text = "Paolo Vitiello          Lorenzo Stasi          Andrea Spinelli"
    text_y  = H - 8               # bottom-aligned
    text_w  = len(text) * 8

    for x in range(-text_w, W + 1):
        frame = bytearray(img)
        fb = framebuf.FrameBuffer(frame, W, H, framebuf.MONO_HLSB)
        fb.text(text, x, text_y, 1)
        oled.show_image(frame)
        sleep_ms(10)

    #lower garage shutter
    for y in range(14, 0, -1):
        oled.display.rect(126, 64-y, 2, 1, 1)
        oled.display.show()
        sleep_ms(200)

    sleep_ms(1000)
    
#128x64
logo = bytearray(b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\xc7\x07\x38\x38\xe0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\xc7\x07\x38\x38\xe0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\xc7\x07\x38\x38\xe0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x20\x82\x10\x41\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x10\x82\x10\x42\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x08\xc2\x10\xc4\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x08\x42\x10\x84\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe0\x08\x42\x10\x84\x01\xc0\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe0\x08\x42\x10\x84\x01\xc0\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe0\x08\x42\x10\x84\x01\xc0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x10\x3f\xff\xff\xff\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x08\x20\x00\x00\x01\x04\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x07\xe0\x00\x00\x01\xf8\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe0\x20\x00\x00\x01\x01\xc0\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe0\x21\xff\x80\xc1\x01\xc0\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe0\x21\xff\xc0\xc1\x01\xc0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x1c\x20\x00\x60\xc1\x0e\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x07\xe0\x00\x30\xc1\xf8\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x20\x00\x30\xc1\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x20\x00\x30\xc1\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x20\x00\x30\xc1\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe0\x20\x00\x30\xc1\x01\xc0\x00\x00\x00\x00\x00\x00\x00\x00\x00\xff\xe0\x00\x30\xc1\xff\xc0\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe0\x20\x00\x60\xc1\x01\xc0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x20\x3f\xc0\xc1\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x20\x7f\x80\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe0\x20\xc0\x00\xc1\x01\xc0\x00\x00\x00\x00\x00\x00\x00\x00\x00\xff\xe1\x80\x00\xc1\xff\xc0\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe0\x21\x80\x00\xc1\x01\xc0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x21\x80\x00\xc1\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x21\x80\x00\xc1\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x21\x80\x00\xc1\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x07\xe1\x80\x00\xc1\xf8\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x1c\x20\xc0\x00\xc1\x0e\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe0\x20\x7f\xf0\xc1\x01\xc0\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe0\x20\x3f\xf0\xc1\x01\xc0\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe0\x20\x00\x00\x01\x01\xc0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x07\xe0\x00\x00\x01\xf8\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x08\x20\x00\x00\x01\x04\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x10\x3f\xff\xff\xff\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe0\x08\x42\x10\x84\x01\xc0\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe0\x08\x42\x10\x84\x01\xc0\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe0\x08\x42\x10\x84\x01\xc0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x08\x42\x10\x84\x00\x00\x00\x00\x00\x03\x00\x00\x00\x00\x00\x00\x08\xc2\x10\xc4\x00\x00\x00\x00\x00\x03\x00\x00\x00\x00\x00\x00\x10\x82\x10\x42\x00\x00\x00\x00\x00\x03\x00\x00\x00\x00\x00\x00\x20\x82\x10\x41\x00\x00\x00\x00\x00\x03\x00\x00\x00\x00\x00\x01\xc7\x07\x38\x38\xe0\x00\x00\x00\x00\x03\x00\x00\x00\x00\x00\x01\xc7\x07\x38\x38\xe0\x00\x00\x00\x00\x03\x00\x00\x00\x00\x00\x01\xc7\x07\x38\x38\xe0\x00\x00\x00\x00\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03')

#126x11
car = bytearray(b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x0f\xfe\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x0f\xe1\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x1f\x10\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x1f\x08\x40\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x3f\x04\x3f\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x7f\xff\xff\xc0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x7f\xff\xff\xe0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x7f\xff\xff\xe0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x7f\xff\xff\xe0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x24\x00\x04\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x18\x00\x03\x00')

oled      = DisplayUI(10, 9)
W, H      = oled.width, oled.height     
Hb        = 11           				 # car sprite height
wb        = W // 8       				 # byte length of every row (16)
mask_line = (1 << W) - 1 				 # mask to keep only the first W bits
y_offset  = H - Hb       				 # vertical positioning of the car at the bottom
car_width = 126
rect_h    = 0

try:
    while True:
        play_animation(oled, W, H, Hb, wb, mask_line, y_offset, car_width, rect_h)
except KeyboardInterrupt:
    oled.display.poweroff()